<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>新しい単語を作ろう</title>

<!-- ★ 追加：トークンチェック（直打ち禁止用） -->
<script>
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  (function validateToken() {
    const urlToken = getQueryParam("t");
    const sessionToken = sessionStorage.getItem("nwgameToken");

    if (!urlToken || !sessionToken || urlToken !== sessionToken) {
      sessionStorage.removeItem("nwgameToken");
      window.location.href = "index.html";
      return;
    }
    sessionStorage.removeItem("nwgameToken");
    window.__NWGAME_TOKEN_OK__ = true;
  })();
</script>

<style>
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    background:#ffffff; color:#000000; display:flex;align-items:center;justify-content:center
  }
  .wrap{width:96%;max-width:980px}


.adg-banner-top{
  width:100%;
  min-height: 100px; /* 最低高さを確保 */
  text-align:center;
  margin: 20px auto; /* 上下の余白を増やす */
  padding: 15px;
  background: #f9f9f9; /* 背景色で目立たせる */
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}



  .card{background:#ffffff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:18px}
  .title{font-weight:800;letter-spacing:.3px;font-size:20px;text-align:center;margin-bottom:6px;color:#000}
  .sub{color:#000;font-size:13px;text-align:center;margin-bottom:14px}
  .panel{display:grid;grid-template-columns:1fr;gap:12px}
  .madeup{font-size:40px;text-align:center;font-weight:900;letter-spacing:4px;color:#000}
  .timer{display:flex;justify-content:center;gap:10px;align-items:center}
  .pill{background:#f3f4f6;padding:8px 10px;border-radius:999px;border:1px solid #e5e7eb;font-size:13px;color:#111827}
  textarea{width:100%;min-height:120px;border-radius:12px;border:1px solid #d1d5db;background:#fff;color:#000;padding:12px;font-size:16px;outline:none}
  textarea:focus{box-shadow:0 0 0 3px rgba(108,160,255,.25)}
  .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  button{cursor:pointer;background:linear-gradient(180deg,#2dd4bf,#00b37d);color:white;border:none;padding:10px 16px;border-radius:10px;font-weight:700;letter-spacing:.3px}
  button:disabled{opacity:.5;cursor:not-allowed}
  .scores{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px}
  .scoreBox{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px;text-align:center;color:#000}
  .scoreBox .v{font-size:26px;font-weight:900}
  .comment{margin-top:14px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;color:#000}
  .comment h4{margin:0 0 8px 0;font-size:13px;color:#111827}
  .aiText{font-size:14px;line-height:1.6;white-space:pre-wrap;color:#000}

.actions{
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:8px;
    margin-top:10px;
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- ★ ゲームページ上部の Ad Generation バナー広告 -->

  <div class="card">
    <div class="title">「新しい単語を作ろう」</div>
    <div class="sub">
      意味のない単語が表示されます。<br>
      あなたが考えた説明文を<br>「自然さ」と「独創性」でAIが採点します。<br>
      100秒以内に意味を考えて送信！<br><span style="font-weight:bold;">100点が最高得点(満点)</span>です。
    </div>

    <div class="panel">
      <div class="madeup" id="madeup">—</div>
      <div class="timer"><span class="pill">残り：<span id="remain">100.0</span>s</span></div>

      <textarea id="input" placeholder="ここに、あなたが考えたこの言葉の“意味”を書いてください（例：○○とは…）" disabled></textarea>

      <div class="actions">
        <button id="btnSubmit" type="button" style="display:none;" disabled>送信</button>
        <button id="btnNext" type="button" style="display:none;">次の言葉</button>
      </div>

      <div class="scores">
        <div class="scoreBox"><div>自然さ<br>（50点）</div><div class="v" id="nat">—</div></div>
        <div class="scoreBox"><div>独創性<br>（50点）</div><div class="v" id="cre">—</div></div>
        <div class="scoreBox"><div>合計<br>（100点）</div><div class="v" id="tot">—</div></div>
      </div>

  <div class="adg-banner-top">

<script>
  function isPC() {
    const ua = navigator.userAgent.toLowerCase();
    return !(ua.includes("iphone") || ua.includes("ipad") || ua.includes("android"));
  }

  if (isPC()) {
    // ★ PC 用広告タグ（あなたの PC 用 ID に差し替える）
    document.write('<script src="https://adm.shinobi.jp/s/783cbff83c9ae012678f4de0e0c8209a"></' + 'script>');
  } else {
    // ★ スマホ用広告タグ（元の219202）
    document.write('<script src="//i.socdm.com/sdk/js/adg-script-loader.js?id=219201&targetID=adg_219201&displayid=1&adType=LARGE&async=true&tagver=2.0.0"></' + 'script>');
  }
</script>

  </div>


      <div class="comment">
        <h4>AIコメント</h4>
        <div id="aiComment" class="aiText">プレイ後にコメントが表示されます。</div>
      </div>

      <div class="actions" aria-label="共有">
        <button id="shareLINE" type="button">友達と共有</button>
        <button id="shareImage" type="button">結果画像</button>
        <button id="copyLink" type="button">サイトリンク</button>
      </div>
    </div>
  </div>
  
  
</div>

<script>
(() => {
  if (!window.__NWGAME_TOKEN_OK__) {
    window.location.href = "index.html";
    return;
  }

  const ROUND_TIME = 100.0;
  const syllables = ['ア','イ','ウ','エ','オ','カ','キ','ク','ケ','コ','サ','シ','ス','セ','ソ','タ','チ','ツ','テ','ト','ナ','ニ','ヌ','ネ','ノ','ハ','ヒ','フ','ヘ','ホ','マ','ミ','ム','メ','モ','ヤ','ユ','ヨ','ラ','リ','ル','レ','ロ','ワ','ガ','ギ','グ','ゲ','ゴ','ザ','ジ','ズ','ゼ','ゾ','ダ','ヂ','ヅ','デ','ド','バ','ビ','ブ','ベ','ボ','パ','ピ','プ','ペ','ポ','ャ','ュ','ョ','ァ','ィ','ゥ','ェ','ォ'];
  const badWords = ['エロ','死','殺','暴','下品'];

  const $ = id => document.getElementById(id);
  const ui = {
    madeup: $('madeup'),
    remain: $('remain'),
    input: $('input'),
    btnSubmit: $('btnSubmit'),
    btnNext: $('btnNext'),
    nat: $('nat'),
    cre: $('cre'),
    tot: $('tot'),
    aiComment: $('aiComment')
  };

  const state = { phase: 'idle', timer: 0, word: '', tickId: 0 };

  function goToAdPageAfterRoundIfNeeded() {
    try {
      let count = Number(localStorage.getItem("nwgamePlayCount") || "0");
      count += 1;
      localStorage.setItem("nwgamePlayCount", String(count));

      if (count % 5 === 0) {
        const token =
          Math.random().toString(36).slice(2) +
          Date.now().toString(36);
        sessionStorage.setItem("nwgameToken", token);
        window.location.href = "ad.html?t=" + encodeURIComponent(token) + "&from=game";
        return true;
      }
    } catch(e){}
    return false;
  }

  let lastInputValue = '';
  let lastInputTime = Date.now();

  function genWord(){
    const r = Math.random();
    let len;
    if (r < 0.85) len = randInt(3,5);
    else if (r < 0.99) len = randInt(6,8);
    else len = randInt(9,14);

    let base = '';
    for (let i = 0; i < len; i++){
      let syl = syllables[Math.floor(Math.random() * syllables.length)];
      if ((syl === 'ャ' || syl === 'ュ' || syl === 'ョ' || syl === 'ァ' || syl === 'ィ' || syl === 'ゥ' || syl === 'ェ' || syl === 'ォ') && base.length === 0) {
        syl = 'ラ';
      }
      base += syl;
    }
    base = base.replace(/[ャュョ]{2,}/g,'ョ').replace(/[ァィゥェォ]{2,}/g,'ォ');
    if (badWords.some(b => base.includes(b))) return genWord();

    let hasNakaguro = false;
    if (Math.random() < 0.05 && base.length >= 3){
      const pos = randInt(1, base.length - 2);
      if (base[pos] !== '・' && base[pos-1] !== '・' && base[pos+1] !== '・'){
        base = base.slice(0, pos) + '・' + base.slice(pos);
        hasNakaguro = true;
      }
    }

    if (len >= 3 && len <= 5 && !hasNakaguro && Math.random() < 0.10) {
      base += 'る';
    }

    if (base.startsWith('・') || base.endsWith('・') || base.includes('・・')){
      return genWord();
    }
    return base;
  }
  function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }

  function startRound(){
    stopTimer();
    state.word = genWord();
    state.phase = 'running';
    state.timer = ROUND_TIME;

    ui.madeup.textContent = state.word;

    ui.input.value = '';
    ui.input.disabled = false;

    ui.btnNext.style.display = 'none';
    ui.btnSubmit.style.display = 'none';
    ui.btnSubmit.disabled = true;

    ui.nat.textContent = '—';
    ui.cre.textContent = '—';
    ui.tot.textContent = '—';
    ui.aiComment.textContent = 'プレイ後にコメントが表示されます。';
    ui.aiComment.style.color = "#000";   // ★ ここで黒に戻す！

    lastInputValue = '';
    lastInputTime = Date.now();

    tick();
    state.tickId = setInterval(tick, 100);
    ui.input.focus();
  }

  function stopTimer(){
    if (state.tickId){
      clearInterval(state.tickId);
      state.tickId = 0;
    }
  }

  function tick(){
    state.timer = Math.max(0, +(state.timer - 0.1).toFixed(1));
    ui.remain.textContent = state.timer.toFixed(1);

    if (state.timer <= 0){
      submitNow();
      return;
    }

    const hasText = ui.input.value.trim().length > 0;
    ui.btnSubmit.style.display = hasText ? 'inline-block' : 'none';
    ui.btnSubmit.disabled = !hasText;
  }

  const API_BASE = "https://word-ai-eval-service.onrender.com";
  fetch(API_BASE + "/", { method: "GET", mode: "no-cors" }).catch(()=>{});

  async function apiEval(text, word){
    const payload = { text, word };
    async function call(){
      const res = await fetch(API_BASE + '/api/eval', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('API error: ' + res.status);
      return res.json();
    }
    try { return await call(); }
    catch(e){
      await new Promise(r=>setTimeout(r, 500));
      return await call();
    }
  }

  function detectPoorExplanation(text) {
    if (text.length <= 8) return true;
    const words = text.split(/\s+/);
    if (words.length > 1) {
      const uniqueWords = new Set(words);
      if (uniqueWords.size / words.length < 0.5) return true;
    }
    if (/(.)\1{3,}/.test(text)) return true;
    return false;
  }

  async function submitNow(){
    if (state.phase !== 'running') return;

    stopTimer();
    state.phase = 'scored';
    ui.input.disabled = true;

    const val = ui.input.value.trim();
    if (!val){
      ui.nat.textContent = '0.0';
      ui.cre.textContent = '0.0';
      ui.tot.textContent = '0.0';
      ui.aiComment.textContent = '何も書かれていないので評価できません。';
      ui.aiComment.style.color = "red";



      ui.btnSubmit.style.display = 'none';
      ui.btnNext.style.display = 'inline-block';
      ui.btnNext.disabled = false;
      return;
    }

    if (detectPoorExplanation(val) && Math.random() < 0.8) {
      ui.nat.textContent = '0.0';
      ui.cre.textContent = '0.0';
      ui.tot.textContent = '0.0';
      ui.aiComment.textContent = '意味の説明が短すぎます。手抜きは止めましょう。';
      ui.aiComment.style.color = "red";

      ui.btnSubmit.style.display = 'none';
      ui.btnNext.style.display = 'inline-block';
      ui.btnNext.disabled = false;
      return;
    }

    ui.aiComment.textContent = 'AIが審査中…';
    ui.aiComment.style.color = "blue";

    try {
      const r = await apiEval(val, state.word);
      ui.nat.textContent = r.nat.toFixed(1);
      ui.cre.textContent = r.cre.toFixed(1);
      ui.tot.textContent = r.tot.toFixed(1);
      ui.aiComment.textContent = (r.comment || "（AIの感想が取得できませんでした）").trim();
      ui.aiComment.style.color = "red";
    } catch(err){
      console.error(err);
      ui.nat.textContent = '—';
      ui.cre.textContent = '—';
      ui.tot.textContent = '—';
      ui.aiComment.textContent = 'サーバー側でエラーが発生しました。時間をおいて再度お試しください。';
      ui.aiComment.style.color = "red";
    }

    ui.btnSubmit.style.display = 'none';
    ui.btnNext.style.display = 'inline-block';
    ui.btnNext.disabled = false;
  }

  function nextWord(){
    if (state.phase !== 'scored') return;

    if (goToAdPageAfterRoundIfNeeded()) return;

    ui.btnNext.disabled = true;
    ui.input.disabled = false;
    startRound();
  }

  function preventCopyPaste(e) {
    const now = Date.now();
    const currentValue = ui.input.value;

    if (e.type === 'paste' || e.type === 'copy' || e.type === 'cut') {
      e.preventDefault();
      return false;
    }

    if (e.type === 'input') {
      const timeDiff = now - lastInputTime;
      const valueDiff = Math.abs(currentValue.length - lastInputValue.length);
      if (timeDiff < 100 && valueDiff > 10) {
        ui.input.value = lastInputValue;
        return;
      }
      lastInputValue = currentValue;
      lastInputTime = now;
    }
  }

  ui.btnSubmit.addEventListener('click', e => { e.preventDefault(); submitNow(); });
  ui.btnNext.addEventListener('click', e => { e.preventDefault(); nextWord(); });

  ui.input.addEventListener('paste', preventCopyPaste);
  ui.input.addEventListener('copy', preventCopyPaste);
  ui.input.addEventListener('cut', preventCopyPaste);
  ui.input.addEventListener('input', preventCopyPaste);

  ui.input.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' &&
        ui.btnSubmit.style.display !== 'none' && !ui.btnSubmit.disabled){
      e.preventDefault();
      submitNow();
    }
  });

  startRound();
})();
</script>

<script>
  function getShareData() {
    const url   = "https://yurugame.lovepop.jp/nw/";
    const title = document.title || "MyGame";
    const word  = (document.getElementById('madeup')?.textContent || '—').trim();
    const nat   = (document.getElementById('nat')?.textContent || '—').trim();
    const cre   = (document.getElementById('cre')?.textContent || '—').trim();
    const tot   = (document.getElementById('tot')?.textContent || '—').trim();
    const desc  = (document.getElementById('input')?.value || '').trim();
    const comment = (document.getElementById('aiComment')?.textContent || '').trim();
    const hasScore = /^\d/.test(tot);
    const totDisp = /点$/.test(tot) ? tot : `${tot}点`;
    const text = hasScore
      ? `意味のない言葉に意味をつけたら、AI判定で${totDisp}でした。\n\nあなたもやってみて！`
      : `造語に意味をつける1分ゲーム。あなたも挑戦してみて！`;
    return { url, title, text, word, nat, cre, tot, desc, comment, hasScore };
  }

  function isHttpUrl(u){ return /^https?:\/\//i.test(u); }

  function shareToLINE() {
    const { word, tot, desc } = getShareData();
    const message =
      `単語に意味をつけたら、AI判定で${tot}点でした。\n\n` +
      `単語（${word}）\n` +
      `私が付けた意味（${desc}）\n\n` +
      `おもしろいよ。なかなか70点まで届かない。\n新しい言葉を作ってみよう。\n` +
      `https://yurugame.lovepop.jp/nw/`;

    if (navigator.share) {
      navigator.share({
        title: "新しい言葉つくりゲーム",
        text: message,
      });
    } else {
      const url = "https://line.me/R/share?text=" + encodeURIComponent(message);
      window.open(url, "_blank", "noopener,noreferrer");
    }
  }

  document.getElementById('shareLINE')?.addEventListener('click', shareToLINE);

  document.getElementById('copyLink')?.addEventListener('click', async () => {
    try { await navigator.clipboard.writeText("https://yurugame.lovepop.jp/nw/"); alert("このページのURLをクリップボードにコピーしました。"); }
    catch (e) { alert("コピーに失敗しました。手動でURLをコピーしてください。"); }
  });
</script>


<style>
/* 画像オーバーレイ（全画面表示） */
#imgOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    padding: 20px;
}

/* 中央に表示する画像ボックス */
#imgBox {
    position: relative;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    padding: 10px;
    max-width: min(480px, 90vw); /* PCでも幅を抑える */
    max-height: 90vh;            /* 画面内に収める */
    overflow: hidden;            /* スクロールさせない */
}

/* 画像 */
#imgBox img {
    max-width: 100%;
    max-height: 80vh; /* 画面に収まりやすく */
    width: auto;
    height: auto;
    border-radius: 12px;
}

/* クローズボタン */
#imgClose {
    position: absolute;
    top: -14px;
    right: -14px;
    background: #ff4444;
    color: #fff;
    width: 42px;
    height: 42px;
    font-size: 22px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    font-weight: bold;
}
</style>

<!-- オーバーレイエリア -->
<div id="imgOverlay">
    <div id="imgBox">
        <div id="imgClose">×</div>
        <img id="resultImg" src="">
    </div>
</div>

<script>
document.getElementById("shareImage")?.addEventListener("click", async () => {
    const { word, nat, cre, tot, desc, comment } = getShareData();

    const width = 900;
    const height = 1600;

    const canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");

    // 背景
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, width, height);

    // カード背景
    const cardX = 50;
    const cardY = 50;
    const cardW = width - 100;
    const cardH = height - 100;
    ctx.fillStyle = "#f9fafb";
    ctx.strokeStyle = "#e5e7eb";
    ctx.lineWidth = 4;
    ctx.fillRect(cardX, cardY, cardW, cardH);
    ctx.strokeRect(cardX, cardY, cardW, cardH);

    // タイトル
    ctx.fillStyle = "#111827";
    ctx.font = "bold 46px 'Yu Gothic', sans-serif";
    ctx.textAlign = "left";
    ctx.fillText("新しい単語を作ろう - 結果", cardX + 40, cardY + 100);

    // 単語
    ctx.font = "bold 80px 'Yu Gothic', sans-serif";
    ctx.fillStyle = "#000";
    ctx.textAlign = "center";
    ctx.fillText(word, width / 2, cardY + 220);
    ctx.textAlign = "left";

    // スコア
    ctx.font = "bold 46px sans-serif";
    ctx.fillStyle = "#111827";
    ctx.fillText(`自然さ： ${nat}`, cardX + 60, cardY + 330);
    ctx.fillText(`独創性： ${cre}`, cardX + 60, cardY + 400);
    ctx.fillText(`合計： ${tot}`, cardX + 60, cardY + 470);

    // ▼ 説明文〜AIコメント：内容に合わせて縦位置を自動調整 ▼
    let y = cardY + 540;

    // 「あなたの説明文」見出し
    ctx.font = "bold 36px sans-serif";
    ctx.fillStyle = "#111827";
    ctx.textAlign = "left";
    ctx.fillText("あなたの説明文", cardX + 60, y);

    // 説明文本体
    y += 44;
    ctx.font = "28px 'Yu Gothic', sans-serif";
    y = wrapText(ctx, desc, cardX + 60, y, cardW - 120, 34);

    // 説明文とAIコメントの間の余白（固定の大きな空白ではない）
    y += 26;

    // 「AIコメント」見出し
    ctx.font = "bold 36px sans-serif";
    ctx.fillStyle = "#111827";
    ctx.fillText("AIコメント", cardX + 60, y);

    // AIコメント本体
    y += 44;
    ctx.font = "28px 'Yu Gothic', sans-serif";
    y = wrapText(ctx, comment, cardX + 60, y, cardW - 120, 34);
    // ▲ ここまでで、説明文が短くても長くても、その直下にAIコメントが続く ▲

    // URL
    ctx.font = "24px sans-serif";
    ctx.fillStyle = "#6b7280";
    ctx.textAlign = "center";
    ctx.fillText("https://yurugame.lovepop.jp/nw/", width / 2, height - 70);

    // 画像表示（ダウンロードしない）
    const imgURL = canvas.toDataURL("image/png");
    document.getElementById("resultImg").src = imgURL;
    document.getElementById("imgOverlay").style.display = "flex";

    // テキスト折返し（日本語対応版）: y を返して次に渡す
    function wrapText(context, text, x, y, maxWidth, lineHeight) {
        if (!text) return y;

        const paragraphs = text.split(/\r?\n/);

        for (let p = 0; p < paragraphs.length; p++) {
            const para = paragraphs[p];
            let line = "";

            // 1文字ずつチェック（日本語でもOK）
            for (let i = 0; i < para.length; i++) {
                const ch = para[i];
                const testLine = line + ch;
                const metrics = context.measureText(testLine);

                if (metrics.width > maxWidth && line !== "") {
                    context.fillText(line, x, y);
                    line = ch;
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }

            if (line) {
                context.fillText(line, x, y);
                y += lineHeight;
            }

            // 段落間に少し余白
            y += lineHeight * 0.3;
        }

        return y;
    }
});

// クローズボタンで消す
document.getElementById("imgClose").addEventListener("click", () => {
    document.getElementById("imgOverlay").style.display = "none";
});
</script>



</body>
</html>
